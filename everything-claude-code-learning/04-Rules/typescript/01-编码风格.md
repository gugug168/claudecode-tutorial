# 01-编码风格

> 本文件扩展了 [通用编码风格规范](../common/coding-style.md)，添加 TypeScript/JavaScript 特定内容。

## 📋 概述

这个规则定义了 TypeScript/JavaScript 项目的编码风格规范，包括：
- **不可变性**：如何安全地修改数据
- **错误处理**：如何优雅地处理错误
- **输入验证**：如何确保数据安全
- **Console.log 规范**：调试语句的使用规则

---

## 1️⃣ 不可变性 (Immutability)

### 🎯 核心概念

**不可变性**是指不直接修改现有数据，而是创建包含修改的新数据。这就像：
- ❌ **错误做法**：直接在原画布上涂改（会破坏原作）
- ✅ **正确做法**：复制画布后在副本上修改（保留原作）

### 📝 使用展开运算符 (Spread Operator)

TypeScript/JavaScript 使用 `...` 运算符来实现不可变更新：

```typescript
// ❌ 错误：直接修改对象（Mutation）
function updateUser(user, name) {
  user.name = name  // 直接修改了原对象！
  return user
}

// ✅ 正确：创建新对象（Immutability）
function updateUser(user, name) {
  return {
    ...user,      // 复制原对象的所有属性
    name          // 覆盖 name 属性
  }
}
```

### 💡 为什么不可变性很重要？

| 好处 | 说明 |
|------|------|
| **可预测性** | 数据不会在你不知情的情况下被修改 |
| **易于调试** | 可以随时回溯到之前的状态 |
| **React 友好** | React 依赖不可变数据来检测变化 |

---

## 2️⃣ 错误处理 (Error Handling)

### 🎯 核心概念

当程序出现问题（比如网络请求失败、文件不存在）时，我们需要：
1. **捕获错误**：不让程序崩溃
2. **记录错误**：方便后续排查
3. **友好提示**：告诉用户发生了什么

### 📝 使用 async/await 配合 try-catch

```typescript
// ✅ 标准错误处理模式
try {
  const result = await riskyOperation()  // 可能失败的操作
  return result
} catch (error) {
  // 1. 记录错误到控制台（供开发者查看）
  console.error('操作失败:', error)

  // 2. 抛出用户友好的错误消息
  throw new Error('无法连接到服务器，请检查网络连接')
}
```

### 📊 错误处理流程

```
┌─────────────┐
│ 执行操作    │
└──────┬──────┘
       │
       ├─ 成功 → 返回结果
       │
       └─ 失败 → catch 捕获
                │
                ├─ console.error 记录
                ├─ 抛出友好错误
                └─ 程序继续运行
```

---

## 3️⃣ 输入验证 (Input Validation)

### 🎯 核心概念

**输入验证**就像门卫，检查进入的数据是否符合要求：
- 邮箱格式是否正确？
- 年龄是否在合理范围内？
- 必填字段是否都有值？

### 📝 使用 Zod 进行 Schema 验证

[Zod](https://zod.dev/) 是一个流行的 TypeScript 验证库：

```typescript
import { z } from 'zod'

// 定义验证规则（Schema）
const schema = z.object({
  email: z.string().email(),           // 必须是有效的邮箱格式
  age: z.number().int().min(0).max(150)  // 必须是 0-150 之间的整数
})

// 验证输入数据
const validated = schema.parse(input)
// 如果验证失败，会自动抛出详细的错误信息
```

### 🔍 验证规则示例

| 字段类型 | 验证规则 | 示例 |
|---------|---------|------|
| `string().email()` | 必须是邮箱格式 | `user@example.com` ✅ |
| `number().min(0).max(150)` | 数字范围 0-150 | `25` ✅, `200` ❌ |
| `string().min(3)` | 字符串至少 3 个字符 | `"abc"` ✅, `"ab"` ❌ |

---

## 4️⃣ Console.log 规范

### 🚨 生产代码禁用规则

```typescript
// ❌ 错误：生产代码中不要有 console.log
function processUser(user) {
  console.log('Processing user:', user)  // 调试语句遗留
  return { ...user, processed: true }
}

// ✅ 正确：使用专业的日志库
import { logger } from './logger'

function processUser(user) {
  logger.info('Processing user', { userId: user.id })
  return { ...user, processed: true }
}
```

### 📋 日志级别对照表

| Console 方法 | 专业日志库 | 使用场景 |
|-------------|-----------|---------|
| `console.log()` | `logger.info()` | 一般信息 |
| `console.error()` | `logger.error()` | 错误信息 |
| `console.warn()` | `logger.warn()` | 警告信息 |
| `console.debug()` | `logger.debug()` | 调试信息 |

### ⚙️ 自动检测配置

本规则配合 **Hooks** 自动检测 `console.log`：
- **PostToolUse Hook**：编辑文件后自动警告
- **Stop Hook**：会话结束前审计所有修改的文件

详见：[05-Hooks配置.md](./05-Hooks配置.md)

---

## 🎓 总结

| 规范 | 关键要点 | 工具/库 |
|------|---------|---------|
| **不可变性** | 使用 `...` 展开运算符 | JavaScript/TypeScript 内置 |
| **错误处理** | async/await + try-catch | JavaScript/TypeScript 内置 |
| **输入验证** | 定义 Schema + 验证 | [Zod](https://zod.dev/) |
| **Console.log** | 生产代码禁用，用日志库 | Winston, Pino 等 |

---

## 📖 相关资源

- **通用规范**：[通用编码风格](../common/coding-style.md)
- **测试要求**：[02-测试要求.md](./02-测试要求.md)
- **安全规范**：[03-安全规范.md](./03-安全规范.md)
- **设计模式**：[04-设计模式.md](./04-设计模式.md)
