# 04-è®¾è®¡æ¨¡å¼

> æœ¬æ–‡ä»¶æ‰©å±•äº† [é€šç”¨è®¾è®¡æ¨¡å¼](../common/patterns.md)ï¼Œæ·»åŠ  TypeScript/JavaScript ç‰¹å®šå†…å®¹ã€‚

## ğŸ“‹ æ¦‚è¿°

è¿™ä¸ªè§„åˆ™å®šä¹‰äº† TypeScript/JavaScript é¡¹ç›®ä¸­å¸¸ç”¨çš„è®¾è®¡æ¨¡å¼ï¼ŒåŒ…æ‹¬ï¼š
- **API å“åº”æ ¼å¼**ï¼šç»Ÿä¸€çš„æ¥å£å“åº”ç»“æ„
- **è‡ªå®šä¹‰ Hook æ¨¡å¼**ï¼šReact é€»è¾‘å¤ç”¨
- **ä»“åº“æ¨¡å¼**ï¼šæ•°æ®è®¿é—®å±‚æŠ½è±¡

---

## 1ï¸âƒ£ API å“åº”æ ¼å¼ (API Response Format)

### ğŸ¯ ä¸ºä»€ä¹ˆéœ€è¦ç»Ÿä¸€çš„å“åº”æ ¼å¼ï¼Ÿ

æƒ³è±¡ä¸€ä¸‹ï¼Œå¦‚æœæ¯ä¸ª API è¿”å›çš„æ•°æ®æ ¼å¼éƒ½ä¸ä¸€æ ·ï¼š

```typescript
// âŒ æ··ä¹±çš„å“åº”æ ¼å¼
const response1 = { data: {...} }           // æœ‰äº›ç”¨ data
const response2 = { result: {...} }         // æœ‰äº›ç”¨ result
const response3 = { user: {...}, success: true }  // æœ‰äº›æ··åˆ
const response4 = {..., error: null }       // æœ‰äº›ç”¨ error
```

è¿™ä¼šè®©å‰ç«¯ä»£ç å˜å¾—éå¸¸å¤æ‚ï¼

### âœ… ç»Ÿä¸€çš„ API å“åº”æ ¼å¼

```typescript
// å®šä¹‰ç»Ÿä¸€çš„å“åº”æ¥å£
interface ApiResponse<T> {
  success: boolean      // è¯·æ±‚æ˜¯å¦æˆåŠŸ
  data?: T             // æˆåŠŸæ—¶çš„æ•°æ®è´Ÿè½½
  error?: string       // å¤±è´¥æ—¶çš„é”™è¯¯æ¶ˆæ¯
  meta?: {             // å…ƒæ•°æ®ï¼ˆå¦‚åˆ†é¡µä¿¡æ¯ï¼‰
    total: number      // æ€»è®°å½•æ•°
    page: number       // å½“å‰é¡µç 
    limit: number      // æ¯é¡µè®°å½•æ•°
  }
}
```

### ğŸ“ ä½¿ç”¨ç¤ºä¾‹

```typescript
// âœ… æˆåŠŸå“åº”ï¼ˆå•ä¸ªå¯¹è±¡ï¼‰
const userResponse: ApiResponse<User> = {
  success: true,
  data: {
    id: '1',
    name: 'å¼ ä¸‰',
    email: 'zhangsan@example.com'
  }
}

// âœ… æˆåŠŸå“åº”ï¼ˆåˆ—è¡¨ + åˆ†é¡µï¼‰
const usersResponse: ApiResponse<User[]> = {
  success: true,
  data: [
    { id: '1', name: 'å¼ ä¸‰' },
    { id: '2', name: 'æå››' }
  ],
  meta: {
    total: 100,      // æ€»å…± 100 æ¡è®°å½•
    page: 1,         // ç¬¬ 1 é¡µ
    limit: 10        // æ¯é¡µ 10 æ¡
  }
}

// âœ… å¤±è´¥å“åº”
const errorResponse: ApiResponse<User> = {
  success: false,
  error: 'ç”¨æˆ·ä¸å­˜åœ¨'
}
```

### ğŸ“Š å“åº”æ ¼å¼å¯¹ç…§è¡¨

| åœºæ™¯ | success | data | error | meta |
|------|---------|------|-------|------|
| **æˆåŠŸï¼ˆå•ä¸ªï¼‰** | `true` | å¯¹è±¡ | - | - |
| **æˆåŠŸï¼ˆåˆ—è¡¨ï¼‰** | `true` | æ•°ç»„ | - | åˆ†é¡µä¿¡æ¯ |
| **å¤±è´¥** | `false` | - | é”™è¯¯æ¶ˆæ¯ | - |

---

## 2ï¸âƒ£ è‡ªå®šä¹‰ Hook æ¨¡å¼ (Custom Hooks Pattern)

### ğŸ¯ ä»€ä¹ˆæ˜¯è‡ªå®šä¹‰ Hookï¼Ÿ

**è‡ªå®šä¹‰ Hook** æ˜¯ä¸€ä¸ªä»¥ `use` å¼€å¤´çš„å‡½æ•°ï¼Œå¯ä»¥å¤ç”¨ React ä¸­çš„é€»è¾‘ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         è‡ªå®šä¹‰ Hook çš„å¥½å¤„           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âœ… é€»è¾‘å¤ç”¨ï¼šå¤šä¸ªç»„ä»¶å…±äº«åŒä¸€é€»è¾‘    â”‚
â”‚ âœ… å…³æ³¨ç‚¹åˆ†ç¦»ï¼šUI å’Œé€»è¾‘åˆ†å¼€         â”‚
â”‚ âœ… æ˜“äºæµ‹è¯•ï¼šé€»è¾‘ç‹¬ç«‹äº UI           â”‚
â”‚ âœ… ä»£ç æ•´æ´ï¼šç»„ä»¶ä»£ç æ›´ç®€æ´          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ğŸ“ é˜²æŠ– Hook ç¤ºä¾‹ (useDebounce)

**é—®é¢˜**ï¼šç”¨æˆ·åœ¨æœç´¢æ¡†è¾“å…¥æ—¶ï¼Œæ¯æ¬¡æŒ‰é”®éƒ½ä¼šè§¦å‘æœç´¢è¯·æ±‚ï¼Œé€ æˆæµªè´¹ã€‚

**è§£å†³**ï¼šä½¿ç”¨é˜²æŠ–ï¼ˆdebounceï¼‰æŠ€æœ¯ï¼Œç­‰å¾…ç”¨æˆ·åœæ­¢è¾“å…¥åå†æ‰§è¡Œæœç´¢ã€‚

```typescript
import { useState, useEffect } from 'react'

/**
 * é˜²æŠ– Hookï¼šå»¶è¿Ÿæ›´æ–°å€¼ç›´åˆ°è¾“å…¥åœæ­¢å˜åŒ–
 * @param value - éœ€è¦é˜²æŠ–çš„å€¼
 * @param delay - å»¶è¿Ÿæ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
 * @returns é˜²æŠ–åçš„å€¼
 */
export function useDebounce<T>(value: T, delay: number): T {
  // 1. åˆ›å»ºçŠ¶æ€å­˜å‚¨é˜²æŠ–åçš„å€¼
  const [debouncedValue, setDebouncedValue] = useState<T>(value)

  // 2. ä½¿ç”¨ useEffect è®¾ç½®å®šæ—¶å™¨
  useEffect(() => {
    // è®¾ç½®å®šæ—¶å™¨ï¼šå»¶è¿Ÿæ›´æ–°å€¼
    const handler = setTimeout(() => {
      setDebouncedValue(value)
    }, delay)

    // 3. æ¸…ç†å‡½æ•°ï¼šç»„ä»¶å¸è½½æˆ–å€¼å˜åŒ–æ—¶æ¸…é™¤å®šæ—¶å™¨
    return () => {
      clearTimeout(handler)
    }
  }, [value, delay])  // ä¾èµ–ï¼švalue æˆ– delay å˜åŒ–æ—¶é‡æ–°æ‰§è¡Œ

  // 4. è¿”å›é˜²æŠ–åçš„å€¼
  return debouncedValue
}
```

### ğŸ’¡ ä½¿ç”¨åœºæ™¯ç¤ºä¾‹

```typescript
// åœ¨ç»„ä»¶ä¸­ä½¿ç”¨é˜²æŠ– Hook
function SearchComponent() {
  const [searchTerm, setSearchTerm] = useState('')
  const debouncedSearchTerm = useDebounce(searchTerm, 500)  // 500ms å»¶è¿Ÿ

  useEffect(() => {
    // åªæœ‰å½“ç”¨æˆ·åœæ­¢è¾“å…¥ 500ms åæ‰ä¼šæ‰§è¡Œæœç´¢
    if (debouncedSearchTerm) {
      searchUsers(debouncedSearchTerm)
    }
  }, [debouncedSearchTerm])

  return (
    <input
      type="text"
      value={searchTerm}
      onChange={(e) => setSearchTerm(e.target.value)}
      placeholder="æœç´¢ç”¨æˆ·..."
    />
  )
}
```

### ğŸ¬ é˜²æŠ–å·¥ä½œæµç¨‹

```
ç”¨æˆ·è¾“å…¥: A    B    C         D         E
         â†“    â†“    â†“         â†“         â†“
æ—¶é—´è½´: 0ms 100ms 200ms     600ms     700ms
                â”‚         â”‚
                â”‚         â””â”€ è§¦å‘æœç´¢ (ABC)
                â”‚
                â””â”€ æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨ï¼Œé‡æ–°è®¡æ—¶

ç»“æœï¼šåªåœ¨ç”¨æˆ·åœæ­¢è¾“å…¥ 500ms åæ‰æ‰§è¡Œä¸€æ¬¡æœç´¢
```

---

## 3ï¸âƒ£ ä»“åº“æ¨¡å¼ (Repository Pattern)

### ğŸ¯ ä»€ä¹ˆæ˜¯ä»“åº“æ¨¡å¼ï¼Ÿ

**ä»“åº“æ¨¡å¼**å°±åƒä¸€ä¸ªå›¾ä¹¦é¦†ç®¡ç†å‘˜ï¼š
- ä½ ä¸éœ€è¦çŸ¥é“ä¹¦æ”¾åœ¨å“ªä¸ªä¹¦æ¶
- åªéœ€è¦å‘Šè¯‰ç®¡ç†å‘˜ä½ è¦ä»€ä¹ˆä¹¦
- ç®¡ç†å‘˜ä¼šå¸®ä½ æ‰¾åˆ°å¹¶ç»™ä½ 

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         ä»“åº“æ¨¡å¼çš„å¥½å¤„               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âœ… æ•°æ®è®¿é—®é›†ä¸­ç®¡ç†                  â”‚
â”‚ âœ… æ˜“äºåˆ‡æ¢æ•°æ®æºï¼ˆMySQL â†’ MongoDBï¼‰â”‚
â”‚ âœ… ä¸šåŠ¡é€»è¾‘ä¸æ•°æ®å­˜å‚¨åˆ†ç¦»            â”‚
â”‚ âœ… æ˜“äºæµ‹è¯•ï¼ˆå¯ä»¥ mock æ•°æ®ï¼‰        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ğŸ“ ä»“åº“æ¥å£å®šä¹‰

```typescript
/**
 * å®šä¹‰æ•°æ®è®¿é—®çš„æ ‡å‡†æ¥å£
 * @template T - å®ä½“ç±»å‹ï¼ˆå¦‚ User, Productï¼‰
 */
interface Repository<T> {
  // æŸ¥æ‰¾æ‰€æœ‰è®°å½•ï¼ˆæ”¯æŒè¿‡æ»¤ï¼‰
  findAll(filters?: Filters): Promise<T[]>

  // æ ¹æ® ID æŸ¥æ‰¾å•ä¸ªè®°å½•
  findById(id: string): Promise<T | null>

  // åˆ›å»ºæ–°è®°å½•
  create(data: CreateDto): Promise<T>

  // æ›´æ–°è®°å½•
  update(id: string, data: UpdateDto): Promise<T>

  // åˆ é™¤è®°å½•
  delete(id: string): Promise<void>
}
```

### ğŸ’¡ å®é™…åº”ç”¨ç¤ºä¾‹

```typescript
// 1. å®šä¹‰ç±»å‹
interface User {
  id: string
  name: string
  email: string
}

interface CreateUserDto {
  name: string
  email: string
}

interface UpdateUserDto {
  name?: string
  email?: string
}

// 2. å®ç° User ä»“åº“
class UserRepository implements Repository<User> {
  async findAll(filters?: { name?: string }): Promise<User[]> {
    // å®ç°æŸ¥è¯¢é€»è¾‘ï¼ˆå¯ä»¥è¿æ¥æ•°æ®åº“ã€API ç­‰ï¼‰
    const query = filters?.name ? { name: filters.name } : {}
    return database.find('users', query)
  }

  async findById(id: string): Promise<User | null> {
    return database.findById('users', id)
  }

  async create(data: CreateUserDto): Promise<User> {
    return database.insert('users', data)
  }

  async update(id: string, data: UpdateUserDto): Promise<User> {
    return database.update('users', id, data)
  }

  async delete(id: string): Promise<void> {
    database.delete('users', id)
  }
}

// 3. åœ¨æœåŠ¡ä¸­ä½¿ç”¨
class UserService {
  constructor(private userRepository: UserRepository) {}

  async getUser(id: string) {
    return this.userRepository.findById(id)
  }

  async createUser(data: CreateUserDto) {
    return this.userRepository.create(data)
  }
}

// 4. ä½¿ç”¨æœåŠ¡
const userRepository = new UserRepository()
const userService = new UserService(userRepository)

const user = await userService.createUser({
  name: 'å¼ ä¸‰',
  email: 'zhangsan@example.com'
})
```

### ğŸ“Š ä»“åº“æ¨¡å¼æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Controller â”‚ â† å¤„ç† HTTP è¯·æ±‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Service   â”‚ â† ä¸šåŠ¡é€»è¾‘å±‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Repository  â”‚ â† æ•°æ®è®¿é—®å±‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Database   â”‚ â† æ•°æ®å­˜å‚¨
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ æ€»ç»“

| æ¨¡å¼ | ç”¨é€” | å¥½å¤„ |
|------|------|------|
| **API å“åº”æ ¼å¼** | ç»Ÿä¸€æ¥å£è¿”å›ç»“æ„ | å‰ç«¯å¤„ç†æ›´ç®€å•ã€ä¸€è‡´ |
| **è‡ªå®šä¹‰ Hook** | å¤ç”¨ React é€»è¾‘ | ä»£ç å¤ç”¨ã€å…³æ³¨ç‚¹åˆ†ç¦» |
| **ä»“åº“æ¨¡å¼** | æŠ½è±¡æ•°æ®è®¿é—®å±‚ | æ˜“äºæµ‹è¯•ã€åˆ‡æ¢æ•°æ®æº |

---

## ğŸ“– ç›¸å…³èµ„æº

- **é€šç”¨è®¾è®¡æ¨¡å¼**ï¼š[é€šç”¨è®¾è®¡æ¨¡å¼](../common/patterns.md)
- **ç¼–ç é£æ ¼**ï¼š[01-ç¼–ç é£æ ¼.md](./01-ç¼–ç é£æ ¼.md)
- **React Hooks æ–‡æ¡£**ï¼š[https://react.dev/reference/react](https://react.dev/reference/react)
- **è®¾è®¡æ¨¡å¼æŒ‡å—**ï¼š[Refactoring.guru](https://refactoring.guru/design-patterns)
