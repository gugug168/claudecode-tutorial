# 03-安全规范

> 本文件扩展了 [通用安全规范](../common/security.md)，添加 TypeScript/JavaScript 特定内容。

## 📋 概述

这个规则定义了 TypeScript/JavaScript 项目的安全规范，包括：
- **密钥管理**：如何安全地存储和使用密钥
- **代理支持**：安全审查专家

---

## 1️⃣ 密钥管理 (Secret Management)

### 🚨 为什么这很重要？

**密钥泄露**是应用程序最严重的安全漏洞之一：

```
┌─────────────────────────────────────┐
│         密钥泄露的后果               │
├─────────────────────────────────────┤
│ 🔐 数据被窃取                        │
│ 💰 财务损失                          │
│ 👥 用户隐私泄露                      │
│ ⚖️ 法律责任                          │
│ 🏷️ 声誉受损                          │
└─────────────────────────────────────┘
```

### ❌ 错误做法：硬编码密钥

```typescript
// 🚨 绝对不要这样做！
const apiKey = "sk-proj-xxxxx"  // 密钥直接写在代码里

// ❌ 问题：
// 1. 代码提交到 Git 后，密钥永久保存在历史记录中
// 2. 所有能访问代码的人都能看到密钥
// 3. 即使后续删除，历史记录中仍然存在
```

### ✅ 正确做法：使用环境变量

```typescript
// ✅ 从环境变量读取密钥
const apiKey = process.env.OPENAI_API_KEY

// ✅ 验证密钥是否存在
if (!apiKey) {
  throw new Error('OPENAI_API_KEY not configured')
}

// 现在可以安全使用 apiKey
```

### 📋 环境变量对照表

| 平台 | 环境变量文件 | 访问方式 |
|------|------------|---------|
| **Node.js** | `.env` | `process.env.VARIABLE_NAME` |
| **浏览器** | `.env` (构建时) | `import.meta.env.VARIABLE_NAME` |
| **Vercel** | Dashboard 设置 | `process.env.VARIABLE_NAME` |
| **Docker** | docker-compose.yml | 容器内环境变量 |

### 🗂️ .env 文件示例

```bash
# .env 文件（永远不要提交到 Git！）
OPENAI_API_KEY=sk-proj-xxxxx
DATABASE_URL=postgresql://user:pass@localhost:5432/db
JWT_SECRET=your-secret-key-here
```

### ⚙️ 确保安全配置

```json
// .gitignore
# 确保 .env 文件不会被提交
.env
.env.local
.env.*.local
```

---

## 2️⃣ 安全最佳实践

### 🔐 密钥管理的黄金法则

| 法则 | 说明 | 示例 |
|------|------|------|
| **永远不要硬编码** | 密钥不应该出现在代码中 | ❌ `const key = "xxx"` |
| **使用环境变量** | 从环境读取配置 | ✅ `process.env.API_KEY` |
| **验证存在性** | 确保密钥已配置 | ✅ `if (!key) throw new Error()` |
| **最小权限原则** | 只给必要的权限 | 只读 vs 读写 |
| **定期轮换** | 定期更换密钥 | 每季度更换一次 |

### 🛡️ 常见安全问题

| 问题 | 风险 | 解决方案 |
|------|------|---------|
| **硬编码密钥** | 密钥泄露 | 使用环境变量 |
| **.env 文件提交** | 历史记录泄露 | 添加到 .gitignore |
| **日志中打印密钥** | 日志泄露 | 过滤敏感信息 |
| **客户端暴露密钥** | 前端可见密钥 | 仅在后端使用 |

---

## 3️⃣ 代理支持 (Agent Support)

### 🤖 security-reviewer 代理

**security-reviewer** 是专门用于安全审查的专家代理：

| 能力 | 说明 |
|------|------|
| **代码审计** | 检测硬编码密钥、不安全的配置 |
| **OWASP Top 10** | 检查常见 Web 应用安全漏洞 |
| **依赖扫描** | 检测过期的或有漏洞的依赖包 |
| **最佳实践** | 应用行业安全最佳实践 |

### 📝 如何使用 security-reviewer？

```bash
# 在项目中启动安全审查
security-reviewer

# 代理会检查：
# 1. 硬编码的密钥和密码
# 2. 不安全的 API 使用
# 3. SQL 注入风险
# 4. XSS 漏洞
# 5. 依赖包安全问题
```

---

## 4️⃣ 安全检查清单

### ✅ 代码提交前检查

```markdown
- [ ] 确认没有硬编码的密钥
- [ ] 确认 .env 文件在 .gitignore 中
- [ ] 确认敏感数据不在日志中
- [ ] 确认用户输入已验证
- [ ] 确认错误消息不泄露敏感信息
- [ ] 确认依赖包已更新到最新版本
```

### 🔍 安全审查流程

```
┌─────────────┐
│ 编写代码    │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ 自我检查    │ ← 使用检查清单
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ 运行审查工具│ ← security-reviewer
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ 修复问题    │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ 提交代码    │
└─────────────┘
```

---

## 🎓 总结

| 方面 | 要求 | 工具/方法 |
|------|------|----------|
| **密钥存储** | 环境变量 | .env 文件 |
| **密钥访问** | 验证存在性 | `if (!key) throw Error` |
| **Git 安全** | .gitignore 排除 | .env 文件 |
| **安全审查** | 定期审计 | security-reviewer 代理 |
| **最佳实践** | OWASP Top 10 | 安全检查清单 |

---

## 📖 相关资源

- **通用安全规范**：[通用安全规范](../common/security.md)
- **编码风格**：[01-编码风格.md](./01-编码风格.md)
- **OWASP Top 10**：[https://owasp.org/www-project-top-ten](https://owasp.org/www-project-top-ten)
- **security-reviewer 代理**：使用 `security-reviewer` 命令启动
