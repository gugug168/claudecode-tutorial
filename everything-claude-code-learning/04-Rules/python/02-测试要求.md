# Python æµ‹è¯•è¦æ±‚

> æœ¬æ–‡ä»¶åœ¨ [common/testing.md](../common/testing.md) åŸºç¡€ä¸Šï¼Œå¢åŠ äº† Python ç‰¹å®šçš„å†…å®¹ã€‚

---

## ğŸ“‹ è§„åˆ™è¯´æ˜

| é¡¹ç›® | å†…å®¹ |
|------|------|
| **ç”¨é€”** | Python è¯­è¨€ç‰¹å®šçš„æµ‹è¯•è§„èŒƒ |
| **ä½¿ç”¨æ—¶æœº** | ç¼–å†™ Python æµ‹è¯•ã€è¿è¡Œæµ‹è¯•æ—¶å‚è€ƒ |
| **æ ¸å¿ƒèƒ½åŠ›** | pytest æ¡†æ¶ã€è¦†ç›–ç‡æ£€æŸ¥ã€æµ‹è¯•åˆ†ç±» |
| **é€‚ç”¨èŒƒå›´** | Python è¯­è¨€é¡¹ç›® |

---

## ğŸ”§ å…ƒæ•°æ®è¯´æ˜

`paths` å­—æ®µæŒ‡å®šæ­¤è§„åˆ™é€‚ç”¨äºå“ªäº› Python æ–‡ä»¶è·¯å¾„ï¼š

```yaml
paths:
  - "**/*.py"      # Python æºä»£ç æ–‡ä»¶
  - "**/*.pyi"     # Python ç±»å‹å­˜æ ¹æ–‡ä»¶
```

---

## ğŸ§ª æµ‹è¯•æ¡†æ¶

### ä½¿ç”¨ pytest

**pytest** æ˜¯ Python æœ€æµè¡Œçš„æµ‹è¯•æ¡†æ¶ï¼Œå®ƒç®€æ´ã€å¼ºå¤§ã€æ˜“ç”¨ã€‚

### ä¸ºä»€ä¹ˆé€‰æ‹© pytestï¼Ÿ

| ç‰¹æ€§ | è¯´æ˜ |
|------|------|
| **ç®€å•** | æµ‹è¯•å‡½æ•°ç›´æ¥ä½¿ç”¨ `assert`ï¼Œæ— éœ€å­¦ä¹ å¤æ‚ API |
| **å¼ºå¤§** | è‡ªåŠ¨å‘ç°æµ‹è¯•æ–‡ä»¶ï¼Œæ”¯æŒå‚æ•°åŒ–ã€fixtures |
| **çµæ´»** | å¯ä»¥è¿è¡Œå•å…ƒæµ‹è¯•ã€é›†æˆæµ‹è¯•ç­‰ä¸åŒç±»å‹æµ‹è¯• |
| **ç”Ÿæ€ä¸°å¯Œ** | å¤§é‡æ’ä»¶æ”¯æŒï¼ˆå¦‚è¦†ç›–ç‡ã€å¹¶å‘æ‰§è¡Œç­‰ï¼‰ |

### åŸºæœ¬ç”¨æ³•

#### 1. ç¼–å†™æµ‹è¯•

```python
# test_calculator.py
def test_add():
    """æµ‹è¯•åŠ æ³•"""
    result = 2 + 3
    assert result == 5

def test_multiply():
    """æµ‹è¯•ä¹˜æ³•"""
    result = 4 * 5
    assert result == 20
```

**è¯´æ˜ï¼š**
- æµ‹è¯•æ–‡ä»¶åä»¥ `test_` å¼€å¤´æˆ–ä»¥ `_test.py` ç»“å°¾
- æµ‹è¯•å‡½æ•°åä»¥ `test_` å¼€å¤´
- ä½¿ç”¨æ™®é€šçš„ `assert` è¯­å¥æ£€æŸ¥ç»“æœ

#### 2. è¿è¡Œæµ‹è¯•

```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
pytest

# è¿è¡ŒæŒ‡å®šæ–‡ä»¶
pytest test_calculator.py

# è¿è¡ŒæŒ‡å®šæµ‹è¯•å‡½æ•°
pytest test_calculator.py::test_add

# æ˜¾ç¤ºè¯¦ç»†è¾“å‡º
pytest -v

# é‡åˆ°ç¬¬ä¸€ä¸ªå¤±è´¥å°±åœæ­¢
pytest -x
```

#### 3. æŸ¥çœ‹æµ‹è¯•ç»“æœ

```
================ test session starts ================
collected 2 items

test_calculator.py ..                            [100%]

================ 2 passed in 0.02s =================
```

**ç¬¦å·è¯´æ˜ï¼š**
- `.` è¡¨ç¤ºæµ‹è¯•é€šè¿‡
- `F` è¡¨ç¤ºæµ‹è¯•å¤±è´¥
- `E` è¡¨ç¤ºæµ‹è¯•å‡ºé”™

---

## ğŸ“Š è¦†ç›–ç‡æ£€æŸ¥

### ä»€ä¹ˆæ˜¯æµ‹è¯•è¦†ç›–ç‡ï¼Ÿ

**æµ‹è¯•è¦†ç›–ç‡** è¡¡é‡ä½ çš„æµ‹è¯•ä»£ç è¦†ç›–äº†å¤šå°‘æºä»£ç ã€‚è¦†ç›–ç‡è¶Šé«˜ï¼Œè¯´æ˜æµ‹è¯•è¶Šå…¨é¢ã€‚

### è¿è¡Œè¦†ç›–ç‡æ£€æŸ¥

```bash
# ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Šï¼ˆæ˜¾ç¤ºç¼ºå¤±çš„è¡Œï¼‰
pytest --cov=src --cov-report=term-missing
```

**å‚æ•°è¯´æ˜ï¼š**
- `--cov=src`ï¼šæ£€æŸ¥ `src` ç›®å½•çš„ä»£ç è¦†ç›–ç‡
- `--cov-report=term-missing`ï¼šåœ¨ç»ˆç«¯æ˜¾ç¤ºæŠ¥å‘Šï¼Œå¹¶æ ‡æ³¨æœªè¦†ç›–çš„è¡Œå·

### è¾“å‡ºç¤ºä¾‹

```
---------- coverage: platform win32, python 3.11 ----------
Name                 Stmts   Miss  Cover   Missing
--------------------------------------------------
src/calculator.py       10      2    80%   15-16
src/utils.py             5      0   100%
--------------------------------------------------
TOTAL                   15      2    87%
```

**å­—æ®µè¯´æ˜ï¼š**
- **Stmts**ï¼šæ€»è¯­å¥æ•°
- **Miss**ï¼šæœªè¦†ç›–çš„è¯­å¥æ•°
- **Cover**ï¼šè¦†ç›–ç‡ç™¾åˆ†æ¯”
- **Missing**ï¼šæœªè¦†ç›–çš„è¡Œå·

### è¦†ç›–ç‡ç›®æ ‡

| ç±»å‹ | æ¨èè¦†ç›–ç‡ | è¯´æ˜ |
|------|-----------|------|
| æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ | â‰¥ 90% | å…³é”®ä»£ç éœ€è¦å……åˆ†æµ‹è¯• |
| ä¸€èˆ¬åŠŸèƒ½ | â‰¥ 80% | å¸¸è§„åŠŸèƒ½çš„æ ‡å‡†è¦†ç›–ç‡ |
| è¾…åŠ©å·¥å…· | â‰¥ 60% | ç®€å•å·¥å…·å¯ä»¥é€‚å½“é™ä½ |

### ç”Ÿæˆ HTML æŠ¥å‘Š

```bash
# ç”Ÿæˆè¯¦ç»†çš„ HTML è¦†ç›–ç‡æŠ¥å‘Š
pytest --cov=src --cov-report=html

# æŠ¥å‘Šç”Ÿæˆåœ¨ htmlcov/index.html
# åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€æŸ¥çœ‹è¯¦ç»†è¦†ç›–ç‡ä¿¡æ¯
```

---

## ğŸ—‚ï¸ æµ‹è¯•ç»„ç»‡

### ä½¿ç”¨æ ‡è®°åˆ†ç±»æµ‹è¯•

**pytest.mark** å…è®¸ä½ ç»™æµ‹è¯•æ‰“æ ‡ç­¾ï¼Œæ–¹ä¾¿åˆ†ç±»è¿è¡Œä¸åŒç±»å‹çš„æµ‹è¯•ã€‚

### å¸¸ç”¨æµ‹è¯•ç±»å‹

| æ ‡è®° | ç±»å‹ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|------|
| `unit` | å•å…ƒæµ‹è¯• | æµ‹è¯•å•ä¸ªå‡½æ•°æˆ–ç±» | `test_calculate_total()` |
| `integration` | é›†æˆæµ‹è¯• | æµ‹è¯•å¤šä¸ªç»„ä»¶åä½œ | `test_database_connection()` |
| `slow` | æ…¢é€Ÿæµ‹è¯• | è¿è¡Œæ—¶é—´è¾ƒé•¿çš„æµ‹è¯• | `test_large_file_processing()` |

### æ ‡è®°ç¤ºä¾‹

```python
import pytest

@pytest.mark.unit
def test_calculate_total():
    """[å•å…ƒæµ‹è¯•] æµ‹è¯•æ€»ä»·è®¡ç®—"""
    result = calculate_total(price=100, quantity=2)
    assert result == 200

@pytest.mark.unit
def test_calculate_tax():
    """[å•å…ƒæµ‹è¯•] æµ‹è¯•ç¨ç‡è®¡ç®—"""
    result = calculate_tax(price=100, tax_rate=0.1)
    assert result == 10

@pytest.mark.integration
def test_database_connection():
    """[é›†æˆæµ‹è¯•] æµ‹è¯•æ•°æ®åº“è¿æ¥"""
    conn = Database.connect()
    assert conn.is_connected()

@pytest.mark.slow
def test_large_file_processing():
    """[æ…¢é€Ÿæµ‹è¯•] æµ‹è¯•å¤§æ–‡ä»¶å¤„ç†"""
    result = process_file("large_data.csv")
    assert result is not None
```

### è¿è¡Œç‰¹å®šç±»å‹çš„æµ‹è¯•

```bash
# åªè¿è¡Œå•å…ƒæµ‹è¯•
pytest -m unit

# åªè¿è¡Œé›†æˆæµ‹è¯•
pytest -m integration

# è¿è¡Œé™¤æ…¢é€Ÿæµ‹è¯•å¤–çš„æ‰€æœ‰æµ‹è¯•
pytest -m "not slow"

# è¿è¡Œå•å…ƒæµ‹è¯•æˆ–é›†æˆæµ‹è¯•
pytest -m "unit or integration"

# è·³è¿‡é›†æˆæµ‹è¯•
pytest -m "not integration"
```

### è‡ªå®šä¹‰æ ‡è®°

ä½ å¯ä»¥åœ¨ `pytest.ini` é…ç½®æ–‡ä»¶ä¸­å®šä¹‰è‡ªå·±çš„æ ‡è®°ï¼š

```ini
# pytest.ini
[pytest]
markers =
    unit: å•å…ƒæµ‹è¯•æ ‡è®°
    integration: é›†æˆæµ‹è¯•æ ‡è®°
    slow: è¿è¡Œæ—¶é—´è¾ƒé•¿çš„æµ‹è¯•
    smoke: å†’çƒŸæµ‹è¯•ï¼ˆå¿«é€ŸéªŒè¯åŸºæœ¬åŠŸèƒ½ï¼‰
```

---

## ğŸ¯ æµ‹è¯•æœ€ä½³å®è·µ

### 1. æµ‹è¯•å‘½åè§„èŒƒ

```python
# å¥½çš„å‘½åï¼ˆæ¸…æ™°æè¿°æµ‹è¯•å†…å®¹ï¼‰
def test_calculate_total_with_discount():
    """æµ‹è¯•å¸¦æŠ˜æ‰£çš„æ€»ä»·è®¡ç®—"""
    pass

def test_user_login_with_valid_credentials():
    """æµ‹è¯•ä½¿ç”¨æœ‰æ•ˆå‡­è¯ç™»å½•"""
    pass

# ä¸å¥½çš„å‘½åï¼ˆä¸æ¸…æ¥šæµ‹è¯•ä»€ä¹ˆï¼‰
def test_1():
    pass

def test_login_test():
    pass
```

### 2. ä¸€ä¸ªæµ‹è¯•åªéªŒè¯ä¸€ä»¶äº‹

```python
# å¥½çš„æµ‹è¯•ï¼ˆåªéªŒè¯ä¸€ä¸ªåŠŸèƒ½ï¼‰
def test_calculate_total():
    result = calculate_total(price=100, quantity=2)
    assert result == 200

# ä¸å¥½çš„æµ‹è¯•ï¼ˆéªŒè¯å¤šä¸ªåŠŸèƒ½ï¼‰
def test_calculate():
    result1 = calculate_total(100, 2)
    assert result1 == 200

    result2 = calculate_tax(100, 0.1)
    assert result2 == 10  # åº”è¯¥åˆ†å¼€æµ‹è¯•
```

### 3. ä½¿ç”¨æè¿°æ€§çš„æ–­è¨€æ¶ˆæ¯

```python
# å¥½çš„åšæ³•ï¼ˆå¸¦å¤±è´¥æ¶ˆæ¯ï¼‰
def test_user_age():
    assert user.age >= 18, "ç”¨æˆ·å¹´é¾„å¿…é¡»å¤§äºç­‰äº18å²"

# ä¸å¥½çš„åšæ³•ï¼ˆæ²¡æœ‰å¤±è´¥æ¶ˆæ¯ï¼‰
def test_user_age():
    assert user.age >= 18
```

### 4. æµ‹è¯•è¾¹ç•Œæƒ…å†µ

```python
def test_calculate_average():
    # æ­£å¸¸æƒ…å†µ
    assert calculate_average([1, 2, 3, 4, 5]) == 3

    # è¾¹ç•Œæƒ…å†µï¼šç©ºåˆ—è¡¨
    assert calculate_average([]) == 0

    # è¾¹ç•Œæƒ…å†µï¼šå•ä¸ªå…ƒç´ 
    assert calculate_average([5]) == 5

    # è¾¹ç•Œæƒ…å†µï¼šè´Ÿæ•°
    assert calculate_average([-1, 1]) == 0
```

---

## ğŸ› ï¸ Fixturesï¼ˆæµ‹è¯•å¤¹å…·ï¼‰

### ä»€ä¹ˆæ˜¯ Fixtureï¼Ÿ

**Fixture** æ˜¯ pytest çš„ä¸€ä¸ªå¼ºå¤§åŠŸèƒ½ï¼Œç”¨äºä¸ºæµ‹è¯•æä¾›å‡†å¤‡å¥½çš„æ•°æ®ã€å¯¹è±¡æˆ–ç¯å¢ƒã€‚

### åŸºæœ¬ Fixture ç¤ºä¾‹

```python
import pytest

@pytest.fixture
def sample_user():
    """åˆ›å»ºä¸€ä¸ªæµ‹è¯•ç”¨æˆ·"""
    return User(name="å¼ ä¸‰", email="zhangsan@example.com")

def test_user_email(sample_user):
    """æµ‹è¯•ç”¨æˆ·é‚®ç®±"""
    assert sample_user.email == "zhangsan@example.com"

def test_user_name(sample_user):
    """æµ‹è¯•ç”¨æˆ·å"""
    assert sample_user.name == "å¼ ä¸‰"
```

**è¯´æ˜ï¼š**
- `@pytest.fixture` è£…é¥°å™¨å°†å‡½æ•°æ ‡è®°ä¸º fixture
- æµ‹è¯•å‡½æ•°å‚æ•°ä¸­å¼•ç”¨ fixture åç§°ï¼Œpytest ä¼šè‡ªåŠ¨æ³¨å…¥

### é«˜çº§ Fixture ç¤ºä¾‹

```python
@pytest.fixture
def database():
    """åˆ›å»ºæµ‹è¯•æ•°æ®åº“è¿æ¥"""
    db = Database.connect(":memory:")
    db.create_tables()

    yield db  # å°†æ•°æ®åº“æä¾›ç»™æµ‹è¯•ä½¿ç”¨

    # æµ‹è¯•ç»“æŸåæ¸…ç†
    db.close()

def test_insert_user(database):
    """æµ‹è¯•æ’å…¥ç”¨æˆ·"""
    database.insert(User(name="æå››"))
    users = database.get_all_users()
    assert len(users) == 1
```

---

## ğŸ“š å‚è€ƒèµ„æº

- **æŠ€èƒ½æ–‡æ¡£**ï¼šæŸ¥çœ‹ `python-testing` æŠ€èƒ½è·å–è¯¦ç»†çš„ pytest æ¨¡å¼å’Œ fixtures
- **pytest å®˜æ–¹æ–‡æ¡£**ï¼šhttps://docs.pytest.org/
- **pytest-cov æ–‡æ¡£**ï¼šhttps://pytest-cov.readthedocs.io/

---

## ğŸ’¡ å­¦ä¹ æç¤º

**åˆå­¦è€…å»ºè®®ï¼š**

1. **ä»ç®€å•æµ‹è¯•å¼€å§‹**ï¼šå…ˆå­¦ä¼šå†™åŸºæœ¬çš„å•å…ƒæµ‹è¯•
2. **ä¸“æ³¨äºä¸€ä¸ªåŠŸèƒ½**ï¼šæ¯ä¸ªæµ‹è¯•åªéªŒè¯ä¸€ä»¶äº‹
3. **é€æ­¥æé«˜è¦†ç›–ç‡**ï¼šå…ˆè®©æµ‹è¯•è·‘èµ·æ¥ï¼Œå†é€æ­¥æé«˜è¦†ç›–ç‡
4. **å¤šè¯»åˆ«äººçš„æµ‹è¯•**ï¼šå­¦ä¹ å¼€æºé¡¹ç›®çš„æµ‹è¯•å†™æ³•

**å¸¸è§é”™è¯¯ï¼š**

| é”™è¯¯ | è¯´æ˜ | ä¿®æ­£æ–¹æ³• |
|------|------|----------|
| æµ‹è¯•ä¾èµ–é¡ºåº | æµ‹è¯•ä¹‹é—´æœ‰ä¾èµ–å…³ç³» | è®©æ¯ä¸ªæµ‹è¯•ç‹¬ç«‹è¿è¡Œ |
| æµ‹è¯•å¤ªå¤æ‚ | ä¸€ä¸ªæµ‹è¯•åšå¤šä»¶äº‹ | æ‹†åˆ†æˆå¤šä¸ªå°æµ‹è¯• |
| ä¸è¿è¡Œæµ‹è¯• | å†™äº†æµ‹è¯•ä½†ä¸è¿è¡Œ | å…»æˆé¢‘ç¹è¿è¡Œæµ‹è¯•çš„ä¹ æƒ¯ |
| è¦†ç›–ç‡è™šé«˜ | ä¸ºäº†è¦†ç›–ç‡å†™æ— æ„ä¹‰æµ‹è¯• | å…³æ³¨æµ‹è¯•è´¨é‡è€Œéæ•°é‡ |

---

## âœ… æ£€æŸ¥æ¸…å•

åœ¨æäº¤ä»£ç å‰ï¼Œç¡®è®¤ä»¥ä¸‹äº‹é¡¹ï¼š

- [ ] æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼ˆ`pytest`ï¼‰
- [ ] æµ‹è¯•è¦†ç›–ç‡è¾¾æ ‡ï¼ˆ`pytest --cov=src`ï¼‰
- [ ] æµ‹è¯•ä½¿ç”¨äº†åˆé€‚çš„æ ‡è®°ï¼ˆ`@pytest.mark`ï¼‰
- [ ] æµ‹è¯•å‘½åæ¸…æ™°ã€æè¿°æ€§å¼º
- [ ] è¾¹ç•Œæƒ…å†µå·²æµ‹è¯•
- [ ] æ¯ä¸ªæµ‹è¯•ç‹¬ç«‹è¿è¡Œï¼Œä¸ä¾èµ–å…¶ä»–æµ‹è¯•
