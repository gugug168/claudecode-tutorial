# Python å®‰å…¨è§„èŒƒ

> æœ¬æ–‡ä»¶åœ¨ [common/security.md](../common/security.md) åŸºç¡€ä¸Šï¼Œå¢åŠ äº† Python ç‰¹å®šçš„å†…å®¹ã€‚

---

## ğŸ“‹ è§„åˆ™è¯´æ˜

| é¡¹ç›® | å†…å®¹ |
|------|------|
| **ç”¨é€”** | Python è¯­è¨€ç‰¹å®šçš„å®‰å…¨è§„èŒƒ |
| **ä½¿ç”¨æ—¶æœº** | ç¼–å†™ Python ä»£ç ã€å®‰å…¨æ£€æŸ¥æ—¶å‚è€ƒ |
| **æ ¸å¿ƒèƒ½åŠ›** | å¯†é’¥ç®¡ç†ã€å®‰å…¨æ‰«æ |
| **é€‚ç”¨èŒƒå›´** | Python è¯­è¨€é¡¹ç›® |

---

## ğŸ”§ å…ƒæ•°æ®è¯´æ˜

`paths` å­—æ®µæŒ‡å®šæ­¤è§„åˆ™é€‚ç”¨äºå“ªäº› Python æ–‡ä»¶è·¯å¾„ï¼š

```yaml
paths:
  - "**/*.py"      # Python æºä»£ç æ–‡ä»¶
  - "**/*.pyi"     # Python ç±»å‹å­˜æ ¹æ–‡ä»¶
```

---

## ğŸ” å¯†é’¥ç®¡ç†

### ä»€ä¹ˆæ˜¯å¯†é’¥ï¼ˆSecretï¼‰ï¼Ÿ

**å¯†é’¥** æ˜¯æŒ‡æ•æ„Ÿä¿¡æ¯ï¼Œå¦‚ï¼š
- API å¯†é’¥ï¼ˆå¦‚ OpenAI API Keyï¼‰
- æ•°æ®åº“å¯†ç 
- è®¿é—®ä»¤ç‰Œï¼ˆTokenï¼‰
- åŠ å¯†å¯†é’¥

### ä¸ºä»€ä¹ˆä¸èƒ½æŠŠå¯†é’¥å†™åœ¨ä»£ç é‡Œï¼Ÿ

âŒ **é”™è¯¯åšæ³•ï¼š**

```python
# ç»å¯¹ä¸è¦è¿™æ ·åšï¼
api_key = "sk-1234567890abcdef"
database_password = "mypassword123"
```

**é£é™©ï¼š**
- ä»£ç ä¸Šä¼ åˆ° GitHub åï¼Œå¯†é’¥ä¼šè¢«å…¬å¼€
- ä»»ä½•äººéƒ½å¯ä»¥ä½¿ç”¨ä½ çš„å¯†é’¥
- å¯èƒ½é€ æˆæ•°æ®æ³„éœ²æˆ–è´¢äº§æŸå¤±

### æ­£ç¡®åšæ³•ï¼šä½¿ç”¨ç¯å¢ƒå˜é‡

âœ… **æ¨èåšæ³•ï¼š**

```python
import os
from dotenv import load_dotenv

# 1. åŠ è½½ .env æ–‡ä»¶ä¸­çš„ç¯å¢ƒå˜é‡
load_dotenv()

# 2. ä»ç¯å¢ƒå˜é‡è¯»å–å¯†é’¥
api_key = os.environ["OPENAI_API_KEY"]  # å¦‚æœç¼ºå¤±ä¼šæŠ›å‡º KeyError
database_password = os.environ["DB_PASSWORD"]

print(f"å¯†é’¥å·²åŠ è½½: {api_key[:10]}...")  # åªæ˜¾ç¤ºå‰10ä¸ªå­—ç¬¦
```

### è¯¦ç»†æ­¥éª¤è¯´æ˜

#### ç¬¬ä¸€æ­¥ï¼šåˆ›å»º .env æ–‡ä»¶

åœ¨é¡¹ç›®æ ¹ç›®å½•åˆ›å»º `.env` æ–‡ä»¶ï¼š

```env
# .env æ–‡ä»¶ï¼ˆä¸è¦æäº¤åˆ° Gitï¼‰
OPENAI_API_KEY=sk-1234567890abcdef
DB_PASSWORD=mypassword123
DB_HOST=localhost
DB_PORT=5432
```

#### ç¬¬äºŒæ­¥ï¼šå®‰è£… python-dotenv

```bash
pip install python-dotenv
```

#### ç¬¬ä¸‰æ­¥ï¼šåœ¨ Python ä»£ç ä¸­ä½¿ç”¨

```python
import os
from dotenv import load_dotenv

# åŠ è½½ .env æ–‡ä»¶
load_dotenv()

# è¯»å–ç¯å¢ƒå˜é‡
api_key = os.getenv("OPENAI_API_KEY")
database_url = os.getenv("DATABASE_URL")

# æ¨èï¼šå¦‚æœå¯†é’¥ç¼ºå¤±åˆ™æŠ¥é”™ï¼ˆæ›´å®‰å…¨ï¼‰
api_key = os.environ["OPENAI_API_KEY"]  # KeyError if missing
```

### ç¯å¢ƒå˜é‡æ–¹æ³•å¯¹æ¯”

| æ–¹æ³• | è¯´æ˜ | æ¨èåœºæ™¯ |
|------|------|----------|
| `os.getenv("KEY")` | å¦‚æœä¸å­˜åœ¨è¿”å› `None` | å¯é€‰é…ç½® |
| `os.environ["KEY"]` | å¦‚æœä¸å­˜åœ¨æŠ›å‡º `KeyError` | å¿…éœ€é…ç½®ï¼ˆæ¨èï¼‰ |

### æœ€ä½³å®è·µ

```python
import os
from dotenv import load_dotenv

load_dotenv()

class Config:
    """é…ç½®ç±»ï¼šé›†ä¸­ç®¡ç†æ‰€æœ‰é…ç½®"""

    # å¿…éœ€é…ç½®ï¼ˆç¼ºå¤±ä¼šæŠ¥é”™ï¼‰
    OPENAI_API_KEY = os.environ["OPENAI_API_KEY"]
    DB_PASSWORD = os.environ["DB_PASSWORD"]

    # å¯é€‰é…ç½®ï¼ˆä½¿ç”¨é»˜è®¤å€¼ï¼‰
    DEBUG = os.getenv("DEBUG", "false") == "true"
    MAX_RETRIES = int(os.getenv("MAX_RETRIES", "3"))
    TIMEOUT = int(os.getenv("TIMEOUT", "30"))

# ä½¿ç”¨é…ç½®
config = Config()
print(f"API Key: {config.OPENAI_API_KEY[:10]}...")
print(f"Debug Mode: {config.DEBUG}")
```

### .env æ–‡ä»¶å®‰å…¨

**é‡è¦ï¼š** ç¡®ä¿ `.env` æ–‡ä»¶ä¸è¢«æäº¤åˆ° Gitï¼š

```gitignore
# .gitignore æ–‡ä»¶ä¸­æ·»åŠ 
.env
.env.local
.env.*.local
```

**éªŒè¯ .env æ˜¯å¦è¢«å¿½ç•¥ï¼š**

```bash
# æ£€æŸ¥ Git çŠ¶æ€ï¼ˆä¸åº”è¯¥çœ‹åˆ° .env æ–‡ä»¶ï¼‰
git status

# å¦‚æœä¸å°å¿ƒæäº¤äº†ï¼Œä» Git å†å²ä¸­åˆ é™¤
git rm --cached .env
git commit -m "Remove .env from git tracking"
```

---

## ğŸ›¡ï¸ å®‰å…¨æ‰«æ

### ä»€ä¹ˆæ˜¯ Banditï¼Ÿ

**Bandit** æ˜¯ä¸€ä¸ª Python å®‰å…¨æ¼æ´æ‰«æå·¥å…·ï¼Œå®ƒå¯ä»¥ï¼š
- æ£€æµ‹ä»£ç ä¸­çš„å®‰å…¨é—®é¢˜
- å‘ç°æ½œåœ¨çš„å®‰å…¨æ¼æ´
- æä¾›ä¿®å¤å»ºè®®

### å®‰è£… Bandit

```bash
pip install bandit
```

### è¿è¡Œå®‰å…¨æ‰«æ

```bash
# æ‰«ææ•´ä¸ªé¡¹ç›®
bandit -r src/

# æ‰«ææŒ‡å®šæ–‡ä»¶
bandit myfile.py

# æ˜¾ç¤ºè¯¦ç»†è¾“å‡º
bandit -r src/ -v

# åªæŠ¥å‘Šé«˜ä¸¥é‡æ€§é—®é¢˜
bandit -r src/ -ll
```

**å‚æ•°è¯´æ˜ï¼š**
- `-r`ï¼šé€’å½’æ‰«æç›®å½•
- `-v`ï¼šæ˜¾ç¤ºè¯¦ç»†è¾“å‡º
- `-ll`ï¼šåªæ˜¾ç¤ºä½ä¸¥é‡æ€§åŠä»¥ä¸Šé—®é¢˜ï¼ˆé»˜è®¤ï¼šä¸­ã€é«˜ï¼‰

### æ‰«ææŠ¥å‘Šç¤ºä¾‹

```
Run started:2024-01-15 10:30:00.000000

Test results:
>> Issue: [B105:hardcoded_password_string] Possible hardcoded password: 'password123'
   Severity: Low   Confidence: Medium
   Location: src/auth.py:12
   More Info: https://bandit.readthedocs.io/en/latest/plugins/b105_hardcoded_password_string.html
11  def authenticate(username, password):
12      if password == "password123":  # â† è¿™é‡Œæ£€æµ‹åˆ°ç¡¬ç¼–ç å¯†ç 
13          return True

--------------------------------------------------

Code scanned:
        Total lines of code: 1250
        Total lines skipped (#nosec): 5

Run metrics:
        Total issues (by severity):
                Undefined: 0
                Low: 2
                Medium: 1
                High: 0
        Total issues (by confidence):
                Undefined: 0
                Low: 0
                Medium: 3
                High: 0
```

### Bandit æ£€æµ‹çš„é—®é¢˜ç±»å‹

| é—®é¢˜ ID | ä¸¥é‡æ€§ | è¯´æ˜ | ç¤ºä¾‹ |
|---------|--------|------|------|
| B101 | é«˜ | `assert` è¯­å¥å¯ç”¨äºç»•è¿‡è®¤è¯ | `assert user.is_admin` |
| B105 | ä½ | ç¡¬ç¼–ç å¯†ç å­—ç¬¦ä¸² | `if pwd == "password123"` |
| B106 | ä½ | ç¡¬ç¼–ç å¯†ç å‚æ•° | `connect(password="pass")` |
| B108 | ä½ | ä¸´æ—¶æ–‡ä»¶ä¸å®‰å…¨ | `tempfile.mktemp()` |
| B301 | é«˜ | ä½¿ç”¨ pickleï¼ˆå¯èƒ½æ‰§è¡Œä»»æ„ä»£ç ï¼‰ | `pickle.loads(data)` |
| B501 | é«˜ | ä½¿ç”¨ä¸å®‰å…¨çš„ SSL/TLS | `ssl.wrap_socket()` |
| B601 | ä¸­ | å‚æ•°åŒ– Shellï¼ˆShell æ³¨å…¥ï¼‰ | `os.system(cmd)` |

### é…ç½® Bandit

åˆ›å»º `.bandit` é…ç½®æ–‡ä»¶ï¼š

```yaml
# .bandit
exclude_dirs:
  - /tests  # æ’é™¤æµ‹è¯•ç›®å½•
  - /venv   # æ’é™¤è™šæ‹Ÿç¯å¢ƒ

tests:
  - B201    # åªæ£€æŸ¥ç‰¹å®šçš„æ¼æ´
  - B301
  - B601
```

### æ’é™¤æŸè¡Œæ£€æŸ¥

å¦‚æœæŸè¡Œä»£ç ç¡®å®éœ€è¦ï¼ˆç»å®‰å…¨å®¡æŸ¥ï¼‰ï¼Œå¯ä»¥æ’é™¤ï¼š

```python
# nosec (B105)
if password == "known_test_password":
    # è¿™æ˜¯æµ‹è¯•ä»£ç ï¼Œä¸æ˜¯çœŸå®å¯†ç 
    return True
```

---

## ğŸ”’ å…¶ä»–å®‰å…¨æœ€ä½³å®è·µ

### 1. SQL æ³¨å…¥é˜²æŠ¤

âŒ **ä¸å®‰å…¨ï¼š**

```python
# ä¸è¦ç›´æ¥æ‹¼æ¥ SQL
query = f"SELECT * FROM users WHERE name = '{user_input}'"
cursor.execute(query)  # å±é™©ï¼å¯èƒ½è¢«æ³¨å…¥
```

âœ… **å®‰å…¨ï¼š**

```python
# ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢
query = "SELECT * FROM users WHERE name = ?"
cursor.execute(query, (user_input,))  # å®‰å…¨
```

### 2. å‘½ä»¤æ³¨å…¥é˜²æŠ¤

âŒ **ä¸å®‰å…¨ï¼š**

```python
# ä¸è¦ç›´æ¥æ‹¼æ¥å‘½ä»¤
os.system(f"grep {user_input} file.txt")  # å±é™©ï¼
```

âœ… **å®‰å…¨ï¼š**

```python
# ä½¿ç”¨ subprocess å’Œå‚æ•°åˆ—è¡¨
subprocess.run(["grep", user_input, "file.txt"])  # å®‰å…¨
```

### 3. æ•æ„Ÿä¿¡æ¯æ—¥å¿—

âŒ **ä¸å®‰å…¨ï¼š**

```python
# ä¸è¦åœ¨æ—¥å¿—ä¸­æ‰“å°æ•æ„Ÿä¿¡æ¯
logger.info(f"User logged in: {password}")  # å±é™©ï¼
```

âœ… **å®‰å…¨ï¼š**

```python
# åªè®°å½•å¿…è¦ä¿¡æ¯
logger.info(f"User logged in: {username}")  # å®‰å…¨
logger.debug(f"User ID: {user_id}, email: {email[:3]}***@***.com")  # è„±æ•
```

### 4. ä½¿ç”¨ logging è€Œé print

```python
import logging

# é…ç½®æ—¥å¿—
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)

logger = logging.getLogger(__name__)

# ä½¿ç”¨æ—¥å¿—ï¼ˆè€Œé printï¼‰
logger.info("Application started")
logger.error("Database connection failed", exc_info=True)
```

**å¥½å¤„ï¼š**
- å¯ä»¥æ§åˆ¶æ—¥å¿—çº§åˆ«ï¼ˆDEBUGã€INFOã€WARNINGã€ERRORï¼‰
- å¯ä»¥è¾“å‡ºåˆ°æ–‡ä»¶
- åŒ…å«æ—¶é—´æˆ³å’Œä¸Šä¸‹æ–‡ä¿¡æ¯

---

## ğŸ“š å‚è€ƒèµ„æº

- **æŠ€èƒ½æ–‡æ¡£**ï¼šæŸ¥çœ‹ `django-security` æŠ€èƒ½è·å– Django ç‰¹å®šçš„å®‰å…¨æŒ‡å—ï¼ˆå¦‚é€‚ç”¨ï¼‰
- **Bandit å®˜æ–¹æ–‡æ¡£**ï¼šhttps://bandit.readthedocs.io/
- **OWASP Python å®‰å…¨æŒ‡å—**ï¼šhttps://cheatsheetseries.owasp.org/cheatsheets/Python_Security_Cheat_Sheet.html
- **python-dotenv æ–‡æ¡£**ï¼šhttps://github.com/theskumar/python-dotenv

---

## ğŸ’¡ å­¦ä¹ æç¤º

**åˆå­¦è€…å»ºè®®ï¼š**

1. **æ°¸è¿œä¸è¦ç¡¬ç¼–ç å¯†é’¥**ï¼šå…»æˆä½¿ç”¨ç¯å¢ƒå˜é‡çš„ä¹ æƒ¯
2. **å®šæœŸè¿è¡Œå®‰å…¨æ‰«æ**ï¼šåœ¨ CI/CD æµç¨‹ä¸­é›†æˆ bandit
3. **å®¡æŸ¥ä¾èµ–åŒ…**ï¼šæ£€æŸ¥ç¬¬ä¸‰æ–¹åŒ…æ˜¯å¦æœ‰å·²çŸ¥æ¼æ´
4. **å…³æ³¨å®‰å…¨å…¬å‘Š**ï¼šè®¢é˜… Python å®‰å…¨é‚®ä»¶åˆ—è¡¨

**å¸¸è§é”™è¯¯ï¼š**

| é”™è¯¯ | è¯´æ˜ | ä¿®æ­£æ–¹æ³• |
|------|------|----------|
| å¯†é’¥å†™æ­»åœ¨ä»£ç é‡Œ | ä»£ç æ³„éœ²å¯¼è‡´å¯†é’¥æ³„éœ² | ä½¿ç”¨ç¯å¢ƒå˜é‡ |
| .env æ–‡ä»¶æäº¤åˆ° Git | å¯†é’¥è¢«å…¬å¼€åˆ° GitHub | æ·»åŠ åˆ° .gitignore |
| SQL æ‹¼æ¥ | å¯èƒ½è¢« SQL æ³¨å…¥æ”»å‡» | ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢ |
| ä½¿ç”¨ pickle | å¯èƒ½æ‰§è¡Œæ¶æ„ä»£ç  | ä½¿ç”¨ JSON æˆ– msgpack |
| ä¸ä½¿ç”¨ HTTPS | æ•°æ®ä¼ è¾“è¢«çªƒå¬ | å§‹ç»ˆä½¿ç”¨ HTTPS |

---

## âœ… æ£€æŸ¥æ¸…å•

åœ¨æäº¤ä»£ç å‰ï¼Œç¡®è®¤ä»¥ä¸‹äº‹é¡¹ï¼š

- [ ] æ²¡æœ‰ç¡¬ç¼–ç çš„å¯†é’¥ã€å¯†ç 
- [ ] ä½¿ç”¨ç¯å¢ƒå˜é‡ç®¡ç†æ•æ„Ÿä¿¡æ¯
- [ ] `.env` æ–‡ä»¶åœ¨ `.gitignore` ä¸­
- [ ] è¿è¡Œ `bandit -r src/` å®‰å…¨æ‰«æ
- [ ] SQL æŸ¥è¯¢ä½¿ç”¨å‚æ•°åŒ–
- [ ] ä½¿ç”¨ `logging` è€Œé `print` è®°å½•æ•æ„Ÿæ“ä½œ
- [ ] ç¬¬ä¸‰æ–¹ä¾èµ–åŒ…å·²æ›´æ–°åˆ°å®‰å…¨ç‰ˆæœ¬
