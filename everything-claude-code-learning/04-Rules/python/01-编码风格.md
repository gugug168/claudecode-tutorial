# Python 编码风格

> 本文件在 [common/coding-style.md](../common/coding-style.md) 基础上，增加了 Python 特定的内容。

---

## 📋 规则说明

| 项目 | 内容 |
|------|------|
| **用途** | Python 语言特定的编码风格规范 |
| **使用时机** | 编写 Python 代码时参考 |
| **核心能力** | PEP 8、类型注解、不可变性、格式化工具 |
| **适用范围** | Python 语言项目 |

---

## 🔧 元数据说明

`paths` 字段指定此规则适用于哪些 Python 文件路径：

```yaml
paths:
  - "**/*.py"      # Python 源代码文件
  - "**/*.pyi"     # Python 类型存根文件
```

---

## 📏 编码标准

### 基本要求

- **遵循 PEP 8 约定**：Python 官方编码风格指南
- **使用类型注解**：在所有函数签名上标注参数和返回值类型

### 什么是 PEP 8？

**PEP 8** 是 Python 的官方编码风格指南，它定义了如何编写易读、一致的 Python 代码。

**主要规范包括：**
- 使用 4 个空格缩进（不使用 Tab）
- 每行最多 79 个字符（注释和文档字符串最多 72 个字符）
- 使用空行分隔函数和类定义
- 导入语句放在文件顶部，按标准库、第三方库、本地模块分组
- 避免使用多余空格

### 什么是类型注解？

**类型注解** 是在函数定义中标注参数和返回值类型的语法。

**示例：**

```python
# 带类型注解的函数（推荐）
def calculate_total(price: float, quantity: int) -> float:
    """计算总价"""
    return price * quantity

# 不带类型注解（不推荐）
def calculate_total(price, quantity):
    return price * quantity
```

**好处：**
- 让代码更易读
- 帮助 IDE 提供更准确的代码补全
- 可以使用类型检查工具（如 mypy）提前发现错误

---

## 🔒 不可变性

### 为什么优先使用不可变数据结构？

**不可变数据** 是指创建后不能修改的数据。使用不可变数据可以：
- 避免意外修改数据
- 让代码更容易理解和调试
- 在多线程环境中更安全

### 如何创建不可变数据结构？

#### 方法 1：使用 `frozen=True` 的 dataclass

```python
from dataclasses import dataclass

@dataclass(frozen=True)
class User:
    """用户信息（不可变）"""
    name: str
    email: str

# 使用
user = User(name="张三", email="zhangsan@example.com")

# 尝试修改会报错
# user.name = "李四"  # ❌ 报错：无法赋值给 frozen 字段
```

#### 方法 2：使用 `NamedTuple`

```python
from typing import NamedTuple

class Point(NamedTuple):
    """二维坐标点（不可变）"""
    x: float
    y: float

# 使用
point = Point(x=10.0, y=20.0)

# 尝试修改会报错
# point.x = 15.0  # ❌ 报错：无法赋值给属性
```

**对比表格：**

| 特性 | dataclass (frozen) | NamedTuple |
|------|-------------------|------------|
| 语法 | 使用装饰器 `@dataclass(frozen=True)` | 继承 `NamedTuple` |
| 可读性 | 更清晰，支持方法 | 较简洁 |
| 可变性 | 不可变 | 不可变 |
| 推荐场景 | 复杂数据结构 | 简单数据记录 |

---

## 🛠️ 代码格式化工具

### 推荐工具组合

| 工具 | 用途 | 命令示例 |
|------|------|----------|
| **black** | 代码格式化（自动统一风格） | `black .` |
| **isort** | 导入语句排序 | `isort .` |
| **ruff** | 代码检查（替代 flake8/pylint） | `ruff check .` |

### 使用示例

```bash
# 格式化当前目录下的所有 Python 文件
black .

# 排序导入语句
isort .

# 运行代码检查
ruff check .

# 组合使用（一键完成所有格式化）
black . && isort . && ruff check .
```

### 这些工具是做什么的？

#### Black（代码格式化器）

**Black** 是一个"不讲道理"的代码格式化工具，它会自动统一你的代码风格。

**特点：**
- 零配置：开箱即用，不需要配置文件
- 确定性：同样的代码总是格式化成同样的样子
- 团队协作：团队成员不必为代码风格争论

**示例：**

```python
# 格式化前
def calculate(x,y,z):
    return x+y+z

# 格式化后（Black 自动处理）
def calculate(x, y, z):
    return x + y + z
```

#### isort（导入排序器）

**isort** 用来整理 Python 文件顶部的导入语句。

**示例：**

```python
# 整理前
from os import path
import sys
from my_package import my_module
import json

# 整理后（isort 自动处理）
import json
import sys
from os import path
from my_package import my_module
```

**导入顺序规则：**
1. 标准库导入（如 `import os`）
2. 第三方库导入（如 `import requests`）
3. 本地应用/库导入（如 `from myapp import models`）

#### Ruff（代码检查工具）

**Ruff** 是一个快速的 Python 代码检查工具，可以替代多个传统工具。

**检查内容：**
- 语法错误
- 未使用的导入和变量
- 代码风格违规
- 潜在的 bug

---

## 📚 参考资源

- **技能文档**：查看 `python-patterns` 技能获取全面的 Python 惯用语和模式
- **PEP 8 官方文档**：https://peps.python.org/pep-0008/
- **Black 官方文档**：https://black.readthedocs.io/
- **Ruff 官方文档**：https://docs.astral.sh/ruff/

---

## 💡 学习提示

**初学者建议：**

1. **先关注代码正确性**：刚开始学习时，先让代码运行起来
2. **逐步学习风格规范**：熟悉基本语法后，再学习 PEP 8
3. **使用工具辅助**：让 Black 自动处理格式化，减轻记忆负担
4. **阅读优秀代码**：多看开源项目，学习他们的编码风格

**常见错误：**

| 错误 | 说明 | 修正方法 |
|------|------|----------|
| 不一致缩进 | 混用空格和 Tab | 使用 4 个空格 |
| 过长行 | 单行超过 79 字符 | 使用括号换行 |
| 缺少类型注解 | 函数没有类型提示 | 添加 `: 类型` 和 `-> 类型` |
| 导入混乱 | 导入顺序混乱 | 使用 isort 整理 |

---

## ✅ 检查清单

在提交代码前，确认以下事项：

- [ ] 遵循 PEP 8 规范
- [ ] 函数签名包含类型注解
- [ ] 优先使用不可变数据结构
- [ ] 运行 `black .` 格式化代码
- [ ] 运行 `isort .` 整理导入
- [ ] 运行 `ruff check .` 检查代码质量
