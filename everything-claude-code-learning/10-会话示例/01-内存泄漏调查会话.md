<!--
【教学目标】

本示例展示如何使用 Claude Code 进行内存泄漏调试会话。

学习要点：
1. 如何有条理地记录调试过程
2. 如何快速定位问题根源
3. 如何验证修复效果
4. 如何保存有价值的调试技巧

适用场景：
- 生产环境性能问题
- 内存异常增长
- 需要长时间测试的bug

【Claude Code 使用技巧】

1. 使用会话模板保持上下文组织
2. 记录"已完成"清单追踪进度
3. 保存代码对比（修复前/修复后）
4. 记录可复用的调试方法
5. 列出下次会话需要加载的文件

-->

# 会话：内存泄漏调查
**日期：** 2026-01-17
**开始时间：** 09:00
**最后更新：** 12:00

---

## 当前状态

正在调查生产环境的内存泄漏问题。堆内存在24小时内持续增长，没有上限。

### 已完成
- [x] 在预发布环境设置堆快照
- [x] 定位泄漏源头：事件监听器未被清理
- [x] 修复 WebSocket 处理器中的泄漏
- [x] 通过4小时浸泡测试验证修复

### 根本原因
WebSocket 的 `onMessage` 处理器在重连时被添加，但在断开连接时未被移除。经过约1000次重连后，内存从200MB增长到2GB。

### 修复方案
```javascript
// 修复前（泄漏）
socket.on('connect', () => {
  socket.on('message', handleMessage)
})

// 修复后（已修复）
socket.on('connect', () => {
  socket.off('message', handleMessage) // 先移除旧监听器
  socket.on('message', handleMessage)
})

// 更好的方案 - 在断开时清理
socket.on('disconnect', () => {
  socket.removeAllListeners('message')
})
```

### 值得保存的调试技巧
1. 在 T=0 时刻获取堆快照
2. 强制垃圾回收：`global.gc()`
3. 运行可疑操作 N 次
4. 在 T=1 时刻获取堆快照
5. 比较快照 - 查找数量等于 N 的对象

### 下次会话的注意事项
- 在1GB阈值处添加内存监控告警
- 为团队记录此调试模式

### 需要加载的上下文
src/services/websocket.js
