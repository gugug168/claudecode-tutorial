# Doc-Updater（文档更新代理）

## 一句话总结
Doc-Updater 是一个文档和代码地图专家，它会自动分析你的代码库结构，生成架构图和文档，保持文档与代码同步。

---

## 它是什么？（小白视角）

### 用一个比喻来理解

想象你搬进了一个复杂的迷宫般的建筑：

- **没有 Doc-Updater**：每次想找个房间都要自己探索，新人来了完全不知道怎么走
- **有 Doc-Updater**：有位建筑师帮你画好了详细的建筑地图，标明每个房间的用途和通道

**Doc-Updater 就是那位"建筑师"**，它帮你创建和维护代码库的"地图"。

### 什么是代码地图（Codemap）？

代码地图是代码库的架构概览，包含：

| 内容 | 说明 |
|------|------|
| 目录结构 | 项目有哪些文件夹 |
| 入口点 | 应用从哪里开始 |
| 关键模块 | 主要的功能区域 |
| 数据流 | 数据如何在系统中流动 |
| 依赖关系 | 模块之间的依赖 |

---

## 工作原理

```
代码库 ──→ Doc-Updater ──→ 分析仓库结构
    │                           │
    │                           ↓
    │                      分析各模块
    │                           │
    │                           ↓
    │                      生成代码地图
    │                           │
    │                           ↓
    └───────────────←─────── 更新文档
```

---

## 配置详解

```yaml
---
name: doc-updater                                    # 代理名称
description: Documentation and codemap specialist... # 描述
tools: ["Read", "Write", "Edit", "Bash", "Grep", "Glob"]  # 可读写执行
model: haiku                                         # 使用Haiku模型（成本低）
---
```

### 为什么用Haiku？

文档更新任务相对简单，不需要深度思考，用Haiku可以节省Token成本。

---

## 核心职责

1. **代码地图生成** - 从代码库结构创建架构地图
2. **文档更新** - 从代码刷新README和指南
3. **AST分析** - 使用TypeScript编译器API理解结构
4. **依赖映射** - 跟踪模块间的导入/导出
5. **文档质量** - 确保文档与现实匹配

---

## 分析命令

```bash
# 生成代码地图
npx tsx scripts/codemaps/generate.ts

# 依赖关系图
npx madge --image graph.svg src/

# 提取JSDoc
npx jsdoc2md src/**/*.ts
```

---

## 代码地图工作流程

### 1. 分析仓库

```bash
# 识别工作空间/包
# 映射目录结构
# 找到入口点 (apps/*, packages/*, services/*)
# 检测框架模式
```

### 2. 分析模块

对每个模块：
- 提取导出
- 映射导入
- 识别路由
- 找到数据库模型
- 定位Worker

### 3. 生成代码地图

输出结构：
```
docs/CODEMAPS/
├── INDEX.md          # 所有区域概览
├── frontend.md       # 前端结构
├── backend.md        # 后端/API结构
├── database.md       # 数据库schema
├── integrations.md   # 外部服务
└── workers.md        # 后台任务
```

---

## 代码地图格式

```markdown
# [区域] 代码地图

**最后更新:** YYYY-MM-DD
**入口点:** 主文件列表

## 架构
[组件关系的ASCII图]

## 关键模块
| 模块 | 用途 | 导出 | 依赖 |

## 数据流
[数据如何流经这个区域]

## 外部依赖
- package-name - 用途, 版本

## 相关区域
链接到其他代码地图
```

---

## 文档更新工作流程

### 1. 提取

- 读取JSDoc/TSDoc
- 读取README章节
- 读取环境变量
- 读取API端点

### 2. 更新

- README.md
- docs/GUIDES/*.md
- package.json
- API文档

### 3. 验证

- 验证文件存在
- 验证链接有效
- 验证示例可运行
- 验证代码片段可编译

---

## 关键原则

1. **单一信息源** - 从代码生成，不要手动编写
2. **新鲜度时间戳** - 总是包含最后更新日期
3. **Token效率** - 每个代码地图不超过500行
4. **可操作** - 包含确实有效的设置命令
5. **交叉引用** - 链接相关文档

---

## 质量检查清单

- [ ] 代码地图从实际代码生成
- [ ] 所有文件路径验证存在
- [ ] 代码示例可编译/运行
- [ ] 链接已测试
- [ ] 新鲜度时间戳已更新
- [ ] 无过时引用

---

## 什么时候更新

**总是**：新主要功能、API路由变更、依赖添加/删除、架构变更、设置流程修改

**可选**：小bug修复、外观变更、内部重构

---

## 使用方法

### 通过命令调用
```bash
/update-codemaps    # 更新代码地图
/update-docs        # 更新文档
```

### 或者描述需求
```
帮我更新项目的README，让它反映最新的代码结构
```

---

## 实际示例

### INDEX.md 示例

```markdown
# 代码地图索引

最后更新: 2025-02-15

## 概览

本项目是一个AI驱动的SaaS平台，包含以下主要区域：

| 区域 | 描述 | 详情 |
|------|------|------|
| [前端](./frontend.md) | Next.js 15应用 | 用户界面 |
| [后端](./backend.md) | API路由和业务逻辑 | 服务端代码 |
| [数据库](./database.md) | PostgreSQL + Supabase | 数据模型 |
| [集成](./integrations.md) | 外部服务连接 | 第三方API |
| [Workers](./workers.md) | 后台任务 | 异步处理 |

## 快速入口

- 前端入口: `src/app/page.tsx`
- API入口: `src/app/api/`
- 数据库迁移: `supabase/migrations/`
```

### 模块地图示例

```markdown
# 前端代码地图

最后更新: 2025-02-15
入口点:
- src/app/page.tsx (首页)
- src/app/layout.tsx (根布局)
- src/app/(auth)/login/page.tsx (登录页)

## 架构

```
┌─────────────────────────────────────────┐
│                 Layout                   │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐   │
│  │ Header  │ │ Sidebar │ │ Footer  │   │
│  └────┬────┘ └────┬────┘ └────┬────┘   │
│       │           │           │         │
│       └───────────┼───────────┘         │
│                   ▼                     │
│              Page Content               │
│  ┌─────────────────────────────────┐   │
│  │        Feature Components       │   │
│  └─────────────────────────────────┘   │
└─────────────────────────────────────────┘
```

## 关键模块

| 模块 | 用途 | 导出 | 依赖 |
|------|------|------|------|
| components/ | UI组件 | Button, Input, Modal | React |
| hooks/ | 自定义hooks | useAuth, useData | React Query |
| lib/ | 工具函数 | cn, formatDate | date-fns |
```

---

## 注意事项

1. **从代码生成** - 不要手动编写可能过时的信息
2. **保持简洁** - 代码地图不是详细文档
3. **定期更新** - 重大变更后更新
4. **验证链接** - 确保内部链接有效
5. **时间戳** - 让读者知道信息新鲜度

---

## 相关代理

- **planner** - 规划文档更新
- **code-reviewer** - 审查文档变更

## 相关命令

- `/update-codemaps` - 更新代码地图
- `/update-docs` - 更新文档
