# Multi-Execute 多模型协作执行命令

多模型协作执行 - 从计划获取原型 → Claude 重构实现 → 多模型审计交付。

$ARGUMENTS

## 核心协议

- **语言协议**：与工具/模型交互时使用英语，用用户的语言与用户沟通
- **代码主权**：外部模型有**零文件系统写入权限**，所有修改由 Claude 完成
- **脏原型重构**：将 Codex/Gemini 的 Unified Diff 视为"脏原型"，必须重构为生产级代码
- **止损机制**：当前阶段输出验证通过后才进入下一阶段
- **前提条件**：只有用户对计划明确回复 "Y" 后才执行

## 执行工作流

**执行任务**：$ARGUMENTS

### 阶段 0：读取计划

`[Mode: Prepare]`

1. **识别输入类型**：
   - 计划文件路径（如 `.claude/plan/xxx.md`）
   - 直接任务描述

2. **读取计划内容**：
   - 如果提供计划文件路径，读取并解析
   - 提取：任务类型、实施步骤、关键文件、SESSION_ID

3. **执行前确认**：
   - 如果输入是"直接任务描述"或计划缺少 `SESSION_ID` / 关键文件：先与用户确认
   - 如果无法确认用户对计划回复了 "Y"：必须再次确认才能继续

4. **任务类型路由**：

   | 任务类型 | 检测方式 | 路由 |
   |----------|----------|------|
   | **前端** | 页面、组件、UI、样式、布局 | Gemini |
   | **后端** | API、接口、数据库、逻辑、算法 | Codex |
   | **全栈** | 同时包含前后端 | Codex ∥ Gemini 并行 |

### 阶段 1：快速上下文检索

`[Mode: Retrieval]`

**必须使用 MCP 工具进行快速上下文检索，不要手动逐个读取文件**

基于计划中的"关键文件"列表，调用 `mcp__ace-tool__search_context`

### 阶段 3：原型获取

`[Mode: Prototype]`

**根据任务类型路由**：

#### 路由 A：前端/UI/样式 → Gemini

1. 调用 Gemini
2. 输出：`仅 Unified Diff Patch。严禁任何实际修改。`
3. **Gemini 是前端设计权威，其 CSS/React/Vue 原型是最终视觉基线**

#### 路由 B：后端/逻辑/算法 → Codex

1. 调用 Codex
2. 输出：`仅 Unified Diff Patch。严禁任何实际修改。`
3. **Codex 是后端逻辑权威，利用其逻辑推理和调试能力**

#### 路由 C：全栈 → 并行调用

1. **并行调用**（`run_in_background: true`）：
   - Gemini：处理前端部分
   - Codex：处理后端部分

### 阶段 4：代码实现 - Claude 作为代码主权者

`[Mode: Implement]`

1. **读取 Diff**：解析 Codex/Gemini 返回的 Unified Diff Patch
2. **心理沙盒**：模拟应用 Diff，检查逻辑一致性，识别潜在冲突或副作用
3. **重构和清理**：将"脏原型"重构为**高可读、可维护、企业级代码**
4. **最小范围**：变更仅限于需求范围
5. **应用变更**：使用 Edit/Write 工具执行实际修改
6. **自验证**：运行项目的 lint/typecheck/tests

### 阶段 5：审计和交付

`[Mode: Audit]`

#### 5.1 自动审计

**变更生效后，必须立即并行调用** Codex 和 Gemini 进行代码审查

#### 5.2 整合并修复

1. 综合 Codex + Gemini 审查反馈
2. 按信任规则权衡：后端遵循 Codex，前端遵循 Gemini
3. 执行必要修复

#### 5.3 交付确认

```markdown
## 执行完成

### 变更摘要
| 文件 | 操作 | 描述 |
|------|------|------|
| path/to/file.ts | 修改 | 描述 |

### 审计结果
- Codex: <通过/发现 N 个问题>
- Gemini: <通过/发现 N 个问题>

### 建议
1. [ ] <建议的测试步骤>
2. [ ] <建议的验证步骤>
```

## 关键规则

1. **代码主权** – 所有文件修改由 Claude 完成
2. **脏原型重构** – Codex/Gemini 输出视为草稿，必须重构
3. **信任规则** – 后端遵循 Codex，前端遵循 Gemini
4. **最小变更** – 只修改必要的代码
5. **强制审计** – 变更后必须进行多模型代码审查

## 用法

```bash
# 执行计划文件
/ccg:execute .claude/plan/feature-name.md

# 直接执行任务（用于上下文中已讨论的计划）
/ccg:execute implement user authentication based on previous plan
```
